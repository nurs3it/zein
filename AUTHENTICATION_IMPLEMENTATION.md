# Реализация аутентификации с Loading Screen

## Проблемы, которые были решены

### 1. Глюк гидратации (hydration mismatch)

**Проблема**: Сначала показывался контент для неавторизованных пользователей, затем резко менялся на авторизованный контент.

**Решение**: Реализован красивый Loading Screen, который показывается до готовности информации о сессии, полностью устраняя визуальные глюки переключения контента.

### 2. Отсутствие Loading Screen

**Проблема**: Пользователь видел мгновенную смену контента без плавного перехода.

**Решение**: Создан красивый полноэкранный Loading Screen с:

- Анимированным логотипом
- Вращающимися иконками
- Прогресс-баром
- Анимированными частицами на фоне

### 3. Проблемы с автообновлением токенов

**Проблема**: Токены не обновлялись автоматически или обновлялись некорректно.

**Решение**: Исправлена логика автообновления:

- Сокращено время до обновления с 10 до 5 минут
- Улучшена обработка после успешного обновления
- Добавлено принудительное обновление состояния

### 4. Кнопки в хедере

**Проблема**: Отдельные кнопки "Платформа" и "Выйти" занимали много места.

**Решение**: Создан компактный dropdown с:

- Аватаром пользователя
- Именем и email
- Кнопками действий

## Архитектура решения

### Client Side

```
useAuth Hook
├── Локальная валидация JWT токенов из cookies
├── Автообновление токенов за 5 минут до истечения
├── Принудительное обновление состояния после логина
└── Предоставляет состояние isLoading

HomePage Component
├── Показывает Loading Screen пока isLoading = true
├── Плавное появление контента после готовности
├── Использует dropdown для авторизованных пользователей
└── Адаптивный контент в зависимости от статуса
```

### Loading Screen

```
LoadingScreen Component
├── Полноэкранная анимация
├── Анимированный логотип (float)
├── Вращающиеся иконки
├── Прогресс-бар (loading-bar)
├── Анимированные частицы
└── Кастомные CSS анимации
```

## Технические детали

### useAuth Hook

- Локальная валидация JWT токенов из cookies
- Автоматическое обновление токенов за 5 минут до истечения
- Принудительное обновление состояния через storage события
- Предоставляет флаг `isLoading` для определения готовности

### Token Management

- Декодирование JWT на клиенте без API запросов
- Проверка времени истечения токенов
- Автоматическая очистка при ошибках
- Инвалидация кешей после изменений

### LoadingScreen

- Полноэкранный overlay с z-index 50
- Кастомные CSS анимации в globals.css
- Анимированные частицы с случайными позициями
- Адаптивный дизайн для темной темы

## Использование

### В компоненте страницы:

```typescript
const { isAuthenticated, user, isLoading } = useAuth();

// Показываем лоадер пока не готова информация о сессии
if (isLoading) {
  return <LoadingScreen message="Проверяем сессию" />;
}

// Используем данные аутентификации
const userName = (user && 'name' in user && user.name) || user?.username || 'Коллега';
```

### В layout:

```typescript
<AppProviders>
  <div className="min-h-screen">
    <SessionStatus showDetails showUserInfo />
    {children}
  </div>
  <Toaster />
</AppProviders>
```

## Результат

1. **Никаких глюков гидратации** - красивый Loading Screen скрывает процесс загрузки
2. **Профессиональная анимация** - пользователь видит красивую загрузку вместо мгновенного переключения
3. **Исправленное автообновление** - токены обновляются корректно за 5 минут до истечения
4. **Компактный UI** - dropdown экономит место в хедере
5. **Стабильная работа** - простое и надежное решение без сложности SSR

## Файлы

- `src/components/ui/loading-screen.tsx` - Компонент полноэкранной загрузки
- `src/app/globals.css` - Кастомные анимации для загрузки
- `src/app/page.tsx` - Главная страница с Loading Screen
- `src/app/layout.tsx` - Упрощенный layout
- `src/shared/hooks/session-hooks.ts` - Исправленные хуки сессии
- `src/features/auth/model/auth-hooks.ts` - Исправленные хуки аутентификации
